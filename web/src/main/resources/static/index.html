<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—á–µ–±–Ω—ã–π —Ü–µ–Ω—Ç—Ä - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-header">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <div class="loading-title">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
            </div>
            <div id="loading-log" class="loading-log"></div>
        </div>

        <div id="error-container" class="hidden"></div>

        <div id="content" class="hidden">
            <!-- Main Navigation -->
            <div class="main-nav">
                <div class="page-selector">
                    <button id="page-selector-button" class="page-selector-button">
                        <span id="current-page-label">üìÖ –°–µ–≥–æ–¥–Ω—è</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div id="page-dropdown" class="page-dropdown hidden">
                        <div class="page-option" data-page="today">üìÖ –°–µ–≥–æ–¥–Ω—è</div>
                        <div class="page-option" data-page="reports">üìä –û—Ç—á–µ—Ç—ã</div>
                        <div class="page-option" data-page="statistics">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                        <div class="page-option" data-page="students">üë• –£—á–µ–Ω–∏–∫–∏</div>
                        <div class="page-option" id="teachers-nav-option" data-page="teachers" style="display: none;">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è</div>
                        <div class="page-option" data-page="audit-log">üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
                    </div>
                </div>
            </div>

            <!-- Pages Container - HTML partials will be loaded here -->
            <div id="pages-container"></div>
        </div>
    </div>

    <!-- Modals Container - HTML partials will be loaded here -->
    <div id="modals-container"></div>

    <!-- Templates for dynamic content -->
    <template id="template-access-denied">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; background: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000);">
            <div style="font-size: 64px; margin-bottom: 20px;">üö´</div>
            <h1 style="font-size: 24px; margin-bottom: 10px;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
            <p style="font-size: 16px; color: var(--tg-theme-hint-color, #999);">–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</p>
        </div>
    </template>

    <!-- Reports Templates -->
    <template id="template-report-student-card">
        <div class="student-card" data-student-id="" style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span class="student-index" style="font-weight: 600; color: #2d3748;"></span>
                    <span class="student-class" style="color: #718096; font-size: 14px; margin-left: 8px;"></span>
                </div>
                <div style="text-align: right;">
                    <div class="student-stats" style="font-size: 14px; color: #4a5568;"></div>
                    <div class="student-payment" style="font-weight: 600; color: #667eea;"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-report-lesson-card">
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div class="lesson-datetime" style="font-weight: 600; color: #2d3748;"></div>
                    <div class="lesson-students" style="color: #4a5568; font-size: 14px; margin-top: 4px;"></div>
                    <div class="lesson-details" style="color: #718096; font-size: 13px; margin-top: 2px;"></div>
                </div>
                <div class="lesson-amount" style="font-weight: 600; color: #667eea; white-space: nowrap;"></div>
            </div>
        </div>
    </template>

    <template id="template-report-payment-card">
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="payment-datetime" style="font-weight: 600; color: #2d3748;"></div>
                    <div class="payment-student" style="color: #4a5568; font-size: 14px; margin-top: 4px;"></div>
                </div>
                <div class="payment-amount" style="font-weight: 600; color: #48bb78;"></div>
            </div>
        </div>
    </template>

    <!-- Student Details Templates -->
    <template id="template-student-detail-lesson">
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div class="lesson-datetime" style="font-weight: 600; color: #2d3748;"></div>
                    <div class="lesson-subject" style="color: #4a5568; font-size: 14px; margin-top: 4px;"></div>
                    <div class="lesson-details" style="color: #718096; font-size: 13px; margin-top: 2px;"></div>
                </div>
                <div class="lesson-amount" style="font-weight: 600; color: #667eea; white-space: nowrap;"></div>
            </div>
        </div>
    </template>

    <template id="template-student-detail-payment">
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="payment-datetime" style="font-weight: 600; color: #2d3748;"></div>
                </div>
                <div class="payment-amount" style="font-weight: 600; color: #48bb78;"></div>
            </div>
        </div>
    </template>

    <!-- Statistics Templates -->
    <template id="template-subject-breakdown">
        <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
            <div class="subject-name" style="font-weight: 600; color: #2d3748; margin-bottom: 8px;"></div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 14px;">
                <div>
                    <div style="color: #718096;">–ó–∞–Ω—è—Ç–∏–π</div>
                    <div class="subject-lessons" style="font-weight: 600; color: #4a5568;"></div>
                </div>
                <div>
                    <div style="color: #718096;">–ò–Ω–¥/–ì—Ä—É–ø–ø</div>
                    <div class="subject-ind-group" style="font-weight: 600; color: #4a5568;"></div>
                </div>
                <div>
                    <div style="color: #718096;">–û–ø–ª–∞—á–µ–Ω–æ</div>
                    <div class="subject-payments" style="font-weight: 600; color: #667eea;"></div>
                </div>
                <div>
                    <div style="color: #718096;">–£—á–µ–Ω–∏–∫–æ–≤</div>
                    <div class="subject-students" style="font-weight: 600; color: #4a5568;"></div>
                </div>
            </div>
        </div>
    </template>

    <!-- Students Templates -->
    <template id="template-student-search-card">
        <div class="student-card" data-student-id="">
            <div class="student-card-header">
                <div class="student-card-title"></div>
                <div class="student-card-id"></div>
            </div>
        </div>
    </template>

    <!-- Teachers Templates -->
    <template id="template-teacher-card">
        <div class="teacher-card">
            <div class="teacher-header">
                <div>
                    <span class="teacher-name"></span>
                    <span class="teacher-id"></span>
                </div>
                <button class="edit-button" data-teacher-id="">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div class="teacher-section">
                <div class="teacher-section-title">–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</div>
                <div class="teacher-permissions"></div>
            </div>
            <div class="teacher-section">
                <div class="teacher-section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</div>
                <div class="teacher-subjects"></div>
            </div>
        </div>
    </template>

    <template id="template-permission-card">
        <div class="permission-card" data-permission="">
            <div class="permission-card-content">
                <span class="permission-label"></span>
                <span class="permission-checkbox-indicator"></span>
            </div>
        </div>
    </template>

    <template id="template-subject-chip">
        <div class="subject-chip">
            <span class="subject-chip-name"></span>
            <button class="subject-chip-remove" type="button">√ó</button>
        </div>
    </template>

    <!-- Today Templates -->
    <template id="template-today-lesson-card">
        <div class="card" style="margin-bottom: 12px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                    <div class="lesson-header" style="font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 4px;"></div>
                    <div class="lesson-student" style="color: #718096; font-size: 14px;"></div>
                </div>
                <div class="lesson-amount" style="font-size: 20px; font-weight: 700; color: #667eea;"></div>
            </div>
            <div class="lesson-badges" style="margin-bottom: 12px;"></div>
            <div style="display: flex; gap: 8px;">
                <button class="button lesson-edit-btn" style="flex: 1;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <button class="button secondary lesson-delete-btn" style="flex: 1;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </template>

    <template id="template-today-payment-card">
        <div class="card" style="margin-bottom: 12px; padding: 16px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                    <div class="payment-header" style="font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 4px;"></div>
                    <div class="payment-student" style="color: #718096; font-size: 14px;"></div>
                </div>
                <div class="payment-amount" style="font-size: 20px; font-weight: 700; color: #48bb78;"></div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="button payment-edit-btn" style="flex: 1;">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <button class="button secondary payment-delete-btn" style="flex: 1;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </template>

    <template id="template-lesson-student-item">
        <div class="lesson-student-item" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 8px; margin-bottom: 4px;">
            <span class="student-name" style="font-weight: 500;"></span>
            <button class="student-remove-btn" style="padding: 4px 8px; background: #fc8181; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </template>

    <template id="template-student-search-result">
        <div class="student-card" style="cursor: pointer; padding: 8px; border: 1px solid #e2e8f0; margin-bottom: 4px; border-radius: 8px;">
            <div class="student-fullname" style="font-weight: 500;"></div>
            <div class="student-class" style="font-size: 12px; color: #718096;"></div>
        </div>
    </template>

    <!-- Audit Log Templates -->
    <template id="template-audit-log-card">
        <div class="card" style="margin-bottom: 8px; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                <div style="flex: 1; min-width: 0;">
                    <div class="log-timestamp" style="font-size: 13px; color: #718096; margin-bottom: 2px;"></div>
                    <div class="log-username" style="font-size: 14px; font-weight: 600; color: #2d3748;"></div>
                    <div class="log-details" style="font-size: 13px; color: #4a5568; margin-top: 2px;"></div>
                </div>
                <span class="action-badge" style="font-size: 11px; padding: 4px 8px; white-space: nowrap;"></span>
            </div>
        </div>
    </template>

    <!-- Load HTML Partials -->
    <script>
        // Check if opened from Telegram WebApp after script loads
        function checkTelegramWebApp() {
            const hasValidTelegram = window.Telegram &&
                                    window.Telegram.WebApp &&
                                    window.Telegram.WebApp.initData &&
                                    window.Telegram.WebApp.initData.length > 0;

            if (!hasValidTelegram) {
                document.body.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üö´</div>
                        <h1 style="font-size: 28px; margin-bottom: 16px; color: #1a1a1a; font-weight: 600;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
                        <p style="font-size: 18px; color: #333; max-width: 450px; line-height: 1.6;">
                            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram WebApp.
                            <br><br>
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç.
                        </p>
                    </div>
                `;
                throw new Error('Not opened from Telegram WebApp');
            }
        }

        // Wait for Telegram script to load
        window.addEventListener('load', function() {
            setTimeout(checkTelegramWebApp, 100);
        });

        // Also check immediately in case script is already loaded
        if (document.readyState === 'complete') {
            setTimeout(checkTelegramWebApp, 100);
        }

        async function loadHTMLPartials() {
            const pages = ['today', 'reports', 'statistics', 'students', 'teachers', 'audit-log'];
            const modals = ['lesson', 'payment', 'student', 'teacher'];

            try {
                // Load pages
                for (const page of pages) {
                    const response = await fetch(`pages/${page}.html`);
                    if (!response.ok) throw new Error(`Failed to load pages/${page}.html`);
                    const html = await response.text();
                    document.getElementById('pages-container').insertAdjacentHTML('beforeend', html);
                }

                // Load modals
                for (const modal of modals) {
                    const response = await fetch(`modals/${modal}.html`);
                    if (!response.ok) throw new Error(`Failed to load modals/${modal}.html`);
                    const html = await response.text();
                    document.getElementById('modals-container').insertAdjacentHTML('beforeend', html);
                }

                console.log('All HTML partials loaded successfully');
            } catch (error) {
                console.error('Error loading HTML partials:', error);
                // Show error to user
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                errorContainer.classList.remove('hidden');
            }
        }

        // Load partials before loading the main application scripts
        loadHTMLPartials().then(() => {
            // Load application scripts after partials are loaded
            const scripts = [
                'template-utils.js',  // Load template utilities first
                'app.js',
                'today.js',
                'reports.js',
                'statistics.js',
                'students.js',
                'teachers.js',
                'audit-log.js'
            ];

            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                document.body.appendChild(script);
            });
        });
    </script>
</body>
</html>
