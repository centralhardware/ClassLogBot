<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–£—á–µ–±–Ω—ã–π —Ü–µ–Ω—Ç—Ä - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-header">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <div class="loading-title">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
            </div>
            <div id="loading-log" class="loading-log"></div>
        </div>

        <div id="error-container" class="hidden"></div>

        <div id="content" class="hidden">
            <!-- Main Navigation -->
            <div class="main-nav">
                <div class="page-selector">
                    <button id="page-selector-button" class="page-selector-button">
                        <span id="current-page-label">üìÖ –°–µ–≥–æ–¥–Ω—è</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div id="page-dropdown" class="page-dropdown hidden">
                        <div class="page-option" data-page="today">üìÖ –°–µ–≥–æ–¥–Ω—è</div>
                        <div class="page-option" data-page="reports">üìä –û—Ç—á–µ—Ç—ã</div>
                        <div class="page-option" data-page="statistics">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                        <div class="page-option" data-page="students">üë• –£—á–µ–Ω–∏–∫–∏</div>
                        <div class="page-option" id="teachers-nav-option" data-page="teachers" style="display: none;">üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è</div>
                        <div class="page-option" data-page="audit-log">üìã –ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
                    </div>
                </div>
            </div>

            <!-- Pages Container - HTML partials will be loaded here -->
            <div id="pages-container"></div>
        </div>
    </div>

    <!-- Modals Container - HTML partials will be loaded here -->
    <div id="modals-container"></div>

    <!-- Load HTML Partials -->
    <script>
        // Check if opened from Telegram WebApp after script loads
        function checkTelegramWebApp() {
            const hasValidTelegram = window.Telegram &&
                                    window.Telegram.WebApp &&
                                    window.Telegram.WebApp.initData &&
                                    window.Telegram.WebApp.initData.length > 0;

            if (!hasValidTelegram) {
                document.body.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; text-align: center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üö´</div>
                        <h1 style="font-size: 28px; margin-bottom: 16px; color: #1a1a1a; font-weight: 600;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
                        <p style="font-size: 18px; color: #333; max-width: 450px; line-height: 1.6;">
                            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Telegram WebApp.
                            <br><br>
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç.
                        </p>
                    </div>
                `;
                throw new Error('Not opened from Telegram WebApp');
            }
        }

        // Wait for Telegram script to load
        window.addEventListener('load', function() {
            setTimeout(checkTelegramWebApp, 100);
        });

        // Also check immediately in case script is already loaded
        if (document.readyState === 'complete') {
            setTimeout(checkTelegramWebApp, 100);
        }

        async function loadHTMLPartials() {
            const pages = ['today', 'reports', 'statistics', 'students', 'teachers', 'audit-log'];
            const modals = ['lesson', 'payment', 'student', 'teacher'];

            try {
                // Load pages
                for (const page of pages) {
                    const response = await fetch(`pages/${page}.html`);
                    if (!response.ok) throw new Error(`Failed to load pages/${page}.html`);
                    const html = await response.text();
                    document.getElementById('pages-container').insertAdjacentHTML('beforeend', html);
                }

                // Load modals
                for (const modal of modals) {
                    const response = await fetch(`modals/${modal}.html`);
                    if (!response.ok) throw new Error(`Failed to load modals/${modal}.html`);
                    const html = await response.text();
                    document.getElementById('modals-container').insertAdjacentHTML('beforeend', html);
                }

                console.log('All HTML partials loaded successfully');
            } catch (error) {
                console.error('Error loading HTML partials:', error);
                // Show error to user
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                errorContainer.classList.remove('hidden');
            }
        }

        // Load partials before loading the main application scripts
        loadHTMLPartials().then(() => {
            // Load application scripts after partials are loaded
            const scripts = [
                'app.js',
                'today.js',
                'reports.js',
                'statistics.js',
                'students.js',
                'teachers.js',
                'audit-log.js'
            ];

            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                document.body.appendChild(script);
            });
        });
    </script>
</body>
</html>
